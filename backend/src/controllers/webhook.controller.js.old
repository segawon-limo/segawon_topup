// Webhook Controller - Handle Payment Notifications
const midtransService = require('../services/midtrans.service');
const vipResellerService = require('../services/vipreseller-working.service');

// Mock database - replace with your actual models
// const { Order, Product } = require('../models');

/**
 * Handle Midtrans Webhook Notification
 */
exports.midtransWebhook = async (req, res) => {
  try {
    console.log('=== Midtrans Webhook Received ===');
    console.log('Body:', JSON.stringify(req.body, null, 2));

    // Process notification
    const result = midtransService.handleNotification(req.body);

    if (!result.success) {
      console.error('Invalid signature or notification');
      return res.status(400).json({ 
        success: false,
        message: 'Invalid notification',
      });
    }

    const { orderId, orderStatus, transactionStatus, paymentType, amount } = result.data;

    // Find order
    const order = await Order.findOne({
      where: { order_number: orderId },
      include: [Product],
    });

    if (!order) {
      console.error('Order not found:', orderId);
      return res.status(404).json({ 
        success: false,
        message: 'Order not found',
      });
    }

    console.log('Order found:', {
      orderNumber: order.order_number,
      currentStatus: order.payment_status,
      newStatus: orderStatus,
    });

    // Update payment status
    await order.update({
      payment_status: orderStatus,
      payment_channel: paymentType,
    });

    // If payment successful, process topup
    if (orderStatus === 'paid' && order.order_status === 'pending') {
      console.log('Payment successful, processing topup...');
      
      // Mark as paid
      await order.update({
        paid_at: new Date(),
      });

      // Process topup in background
      processTopup(order).catch(error => {
        console.error('Background topup error:', error);
      });
    }

    return res.json({ 
      success: true,
      message: 'Notification processed',
    });

  } catch (error) {
    console.error('Midtrans Webhook Error:', error);
    return res.status(500).json({ 
      success: false,
      message: 'Internal server error',
    });
  }
};

/**
 * Handle Xendit Webhook Notification
 */
exports.xenditWebhook = async (req, res) => {
  try {
    console.log('=== Xendit Webhook Received ===');
    console.log('Body:', JSON.stringify(req.body, null, 2));

    const { external_id, status, paid_amount, payment_channel } = req.body;

    // Verify webhook token (optional but recommended)
    const webhookToken = req.headers['x-callback-token'];
    if (webhookToken !== process.env.XENDIT_WEBHOOK_TOKEN) {
      console.error('Invalid webhook token');
      return res.status(401).json({ 
        success: false,
        message: 'Unauthorized',
      });
    }

    // Find order
    const order = await Order.findOne({
      where: { order_number: external_id },
      include: [Product],
    });

    if (!order) {
      console.error('Order not found:', external_id);
      return res.status(404).json({ 
        success: false,
        message: 'Order not found',
      });
    }

    console.log('Order found:', {
      orderNumber: order.order_number,
      currentStatus: order.payment_status,
      newStatus: status,
    });

    // Map Xendit status to our status
    let paymentStatus = 'pending';
    if (status === 'PAID') {
      paymentStatus = 'paid';
    } else if (status === 'EXPIRED') {
      paymentStatus = 'expired';
    } else if (status === 'PENDING') {
      paymentStatus = 'pending';
    }

    // Update payment status
    await order.update({
      payment_status: paymentStatus,
      payment_channel: payment_channel,
    });

    // If payment successful, process topup
    if (paymentStatus === 'paid' && order.order_status === 'pending') {
      console.log('Payment successful, processing topup...');
      
      // Mark as paid
      await order.update({
        paid_at: new Date(),
      });

      // Process topup in background
      processTopup(order).catch(error => {
        console.error('Background topup error:', error);
      });
    }

    return res.json({ 
      success: true,
      message: 'Notification processed',
    });

  } catch (error) {
    console.error('Xendit Webhook Error:', error);
    return res.status(500).json({ 
      success: false,
      message: 'Internal server error',
    });
  }
};

/**
 * Process topup to VIP Reseller (async)
 */
async function processTopup(order) {
  try {
    console.log('=== Processing Topup ===');
    console.log('Order:', order.order_number);
    console.log('Product:', order.Product.sku);
    console.log('User:', order.game_user_id + '#' + order.game_user_tag);

    // Update status to processing
    await order.update({
      order_status: 'processing',
    });

    // Call VIP Reseller API
    const result = await vipResellerService.createTransaction({
      productCode: order.Product.sku,
      userId: order.game_user_id,
      gameTag: order.game_user_tag,
      orderNumber: order.order_number,
    });

    console.log('VIP Reseller Response:', result);

    if (result.success) {
      // Topup successful
      await order.update({
        order_status: 'completed',
        provider_order_id: result.data.transactionId,
        provider_serial_number: result.data.serialNumber || null,
        provider_response: JSON.stringify(result.data),
        processed_at: new Date(),
      });

      console.log('✅ Topup completed successfully!');
      
      // TODO: Send email/SMS notification to customer
      // await sendSuccessNotification(order);

    } else {
      // Topup failed
      await order.update({
        order_status: 'failed',
        provider_response: JSON.stringify(result),
        notes: result.message,
      });

      console.error('❌ Topup failed:', result.message);
      
      // TODO: Send failure notification
      // await sendFailureNotification(order);
    }

  } catch (error) {
    console.error('Process Topup Error:', error);
    
    await order.update({
      order_status: 'failed',
      notes: error.message,
    });
  }
}

/**
 * Test endpoint to manually trigger topup (for testing)
 */
exports.testTopup = async (req, res) => {
  try {
    const { orderNumber } = req.params;

    const order = await Order.findOne({
      where: { order_number: orderNumber },
      include: [Product],
    });

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found',
      });
    }

    if (order.payment_status !== 'paid') {
      return res.status(400).json({
        success: false,
        message: 'Order not paid yet',
      });
    }

    // Process topup
    await processTopup(order);

    return res.json({
      success: true,
      message: 'Topup processed',
    });

  } catch (error) {
    console.error('Test Topup Error:', error);
    return res.status(500).json({
      success: false,
      message: 'Internal server error',
    });
  }
};

module.exports = exports;
